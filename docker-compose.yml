#########################################
# This is the base Docker file          #
# It includes the following containers: #
#  - Flask                              #
#  - MySQL                              #
#########################################

version: "3.9"
services:
    flask:
        container_name: cradle_flask
        build:
            context: ./server
        volumes:
            - flask_uploads:/uploads
        environment:
            PORT: 5000
            DB_HOSTNAME: cradle_mysql
            DB_PORT: 3306
            DB_NAME: cradle
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            JWT_SECRET_KEY: ${JWT_SECRET_KEY}
        depends_on: 
            - mysql
    mysql:
        container_name: cradle_mysql
        image: mysql:5.7
        volumes:
            - mysql_data:/var/lib/mysql
        environment:
            MYSQL_DATABASE: cradle
            MYSQL_USER: ${DB_USERNAME}
            MYSQL_PASSWORD: ${DB_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
    node-exporter:
        image: prom/node-exporter:latest
        container_name: node-exporter
        restart: unless-stopped
        volumes:
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        command:
          - '--path.procfs=/proc'
          - '--path.rootfs=/rootfs'
          - '--path.sysfs=/host/sys'
          - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
        expose:
          - 9100
        networks:
          - monitoring
    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        restart: unless-stopped
        volumes:
          - ./prometheus.yml:/etc/prometheus/prometheus.yml
          - prometheus_data:/prometheus
        command:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--web.console.libraries=/etc/prometheus/console_libraries'
          - '--web.console.templates=/etc/prometheus/consoles'
          - '--web.enable-lifecycle'
        expose:
          - 9090
        networks:
          - monitoring
        environment:
            GRAFANA_API_KEY: ${GRAFANA_API_KEY}


volumes:
    flask_uploads:
    mysql_data:
    prometheus_data:
networks:
    monitoring:
        driver: bridge
